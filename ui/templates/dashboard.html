{{define "dashboard.html"}}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
        <h2 class="text-2xl font-bold">Dashboard</h2>
            <p class="text-xs text-gray-500 mt-1.5 flex items-center gap-3">
                <span class="inline-flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-red-400 font-medium">Real-time</span>
                    <span class="text-gray-600">Redis Streams</span>
                </span>
                <span class="text-gray-700">‚Ä¢</span>
                <span class="inline-flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                    <span class="text-purple-400 font-medium">Historical</span>
                    <span class="text-gray-600">PostgreSQL</span>
                </span>
            </p>
        </div>
        <div class="flex items-center gap-3">
        <div class="flex items-center gap-3 text-sm" id="refresh-controls"
             x-data="{ 
                lastUpdated: new Date(),
                isPaused: false,
                isTabVisible: true,
                toggleAutoRefresh() {
                    this.isPaused = !this.isPaused;
                    this.updateTriggers();
                },
                updateTriggers() {
                    // Auto-refresh only if not paused AND tab is visible
                    const shouldAutoRefresh = !this.isPaused && this.isTabVisible;
                    const trigger = shouldAutoRefresh ? 'load, every 30s, manualRefresh' : 'manualRefresh';
                    
                    document.getElementById('stats')?.setAttribute('hx-trigger', trigger);
                    document.getElementById('queues-content')?.setAttribute('hx-trigger', trigger);
                    document.getElementById('consumers-content')?.setAttribute('hx-trigger', trigger);
                    htmx.process(document.body);
                },
                init() {
                    window.updateDashboardTime = () => {
                        this.lastUpdated = new Date();
                    };
                    
                    // Tab visibility listener - pause auto-refresh when tab is hidden
                    document.addEventListener('visibilitychange', () => {
                        this.isTabVisible = !document.hidden;
                        this.updateTriggers();
                        
                        // When tab becomes visible again, refresh immediately
                        if (this.isTabVisible && !this.isPaused) {
                            htmx.trigger('#stats', 'manualRefresh');
                            htmx.trigger('#queues-content', 'manualRefresh');
                            htmx.trigger('#consumers-content', 'manualRefresh');
                        }
                    });
                }
             }">
            <!-- Auto-refresh indicator -->
            <div class="flex items-center gap-2 text-gray-500">
                <span id="refresh-indicator" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <span class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full transition-colors" :class="isPaused ? 'bg-gray-500' : 'bg-green-500 animate-pulse'"></span>
                    <span>Auto-refresh: 30s</span>
                </span>
            </div>
            
            <!-- Pause/Play button -->
            <button 
                @click="toggleAutoRefresh()"
                class="flex items-center gap-1.5 px-2.5 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded-lg transition-all border border-gray-700 hover:border-gray-600"
                :title="isPaused ? 'Resume auto-refresh' : 'Pause auto-refresh'">
                <!-- Play icon (when paused) -->
                <svg x-show="isPaused" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <!-- Pause icon (when playing) -->
                <svg x-show="!isPaused" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            </button>
            
            <!-- Manual refresh button -->
            <button 
                @click="htmx.trigger('#stats', 'manualRefresh'); htmx.trigger('#queues-content', 'manualRefresh'); htmx.trigger('#consumers-content', 'manualRefresh'); lastUpdated = new Date();"
                class="flex items-center gap-1.5 px-2.5 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded-lg transition-all border border-gray-700 hover:border-gray-600"
                title="Refresh now">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </button>
            
            <!-- Last updated timestamp -->
            <div class="flex items-center gap-1 text-[11px] text-gray-600">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span x-text="lastUpdated.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })">--:--:--</span>
            </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards (PostgreSQL) -->
        {{if .Stats}}
    <div class="bg-gray-900 rounded-xl border border-gray-800" x-data="{ expanded: true }">
        <div class="p-4 border-b border-gray-800 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h3 class="font-semibold">üìä System Statistics</h3>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-purple-900/30 text-purple-400 border border-purple-800/50">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                        <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                        <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                    </svg>
                    Historical ‚Ä¢ PostgreSQL
                </span>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-64 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Task States (PostgreSQL):</div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-400">‚è≥ Pending:</span>
                                    <span class="text-gray-300">Not yet picked up by any worker</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-cyan-400">‚ö° Active:</span>
                                    <span class="text-gray-300">Currently being processed</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-green-400">‚úÖ Completed:</span>
                                    <span class="text-gray-300">Successfully finished</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-red-400">üíÄ Dead:</span>
                                    <span class="text-gray-300">Failed after max retries</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Historical data aggregated across all consumer groups.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="p-4" x-show="expanded" x-transition>
            <div id="stats" 
                 hx-get="/partials/stats" 
                 hx-trigger="load, every 30s, manualRefresh" 
                 hx-swap="innerHTML"
                 hx-indicator="#refresh-indicator">
            {{template "partial_stats.html" .Stats}}
            </div>
        </div>
    </div>
    {{end}}

    <!-- Redis Streams Section (Real-time Data) -->
    <div class="bg-gradient-to-br from-gray-900 to-gray-900/50 rounded-xl border-2 border-red-900/30 overflow-hidden">
        <!-- Redis Section Header with Consumer Group Selector -->
        <div class="bg-gradient-to-r from-red-900/20 via-red-800/10 to-red-900/20 border-b border-red-900/30 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xl">üî¥</span>
                        <h3 class="text-lg font-bold">Real-time Data</h3>
                    </div>
                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs bg-red-900/40 text-red-300 border border-red-800/50 font-medium">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse"></span>
                        Redis Streams
                    </span>
                </div>
                
                <!-- Consumer Group Selector -->
                {{if .ConsumerGroups}}
                <div class="flex items-center gap-3">
                    <label class="text-sm text-gray-400 font-medium">Filter by Consumer Group:</label>
                    <select 
                        onchange="window.location.href = '/?group=' + this.value"
                        class="bg-gray-800 border border-red-800/50 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500/50 hover:border-red-700/50 transition-colors"
                    >
                        {{range .ConsumerGroups}}
                        <option value="{{.Name}}" {{if eq $.SelectedGroup .Name}}selected{{end}}>
                            {{.Name}} ({{.ConsumerCount}} workers)
                        </option>
                        {{end}}
                    </select>
                </div>
                {{else}}
                <div class="text-sm text-gray-500 px-3 py-1.5 bg-gray-800/50 rounded-lg border border-gray-700">
                    No active consumer groups
                </div>
                {{end}}
            </div>
            {{if .SelectedGroup}}
            <p class="text-xs text-gray-500 mt-2 ml-8">Showing workers and queues for <span class="text-red-400 font-medium">{{.SelectedGroup}}</span></p>
            {{end}}
        </div>

        <!-- Redis Section Content -->
        <div class="p-4 space-y-4">

    <!-- Workers in Consumer Group (Redis) -->
    {{if .Consumers}}
    <div class="bg-gray-800/50 rounded-lg border border-gray-700/50" x-data="{ expanded: true }">
        <div class="p-3.5 border-b border-gray-700/50 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h4 class="font-semibold text-base">üë• Active Workers</h4>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-64 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Worker Status:</div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-green-400">üü¢ Active:</span>
                                    <span class="text-gray-300">Idle &lt; 1 minute</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-400">üü° Idle:</span>
                                    <span class="text-gray-300">Idle 1-5 minutes</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-red-400">üî¥ Dead:</span>
                                    <span class="text-gray-300">Idle &gt; 5 minutes</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Dead workers with pending tasks will auto-recover via XAUTOCLAIM.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-500">{{len .Consumers}} workers</span>
                <div class="flex items-center gap-1.5" 
                     x-data="{ showCleanupModal: false }"
                     @htmx:after-swap.window="
                         if ($event.detail.target.id === 'cleanup-result') {
                             const resultText = $event.detail.target.textContent.trim();
                             let type = 'info';
                             if (resultText.includes('Cleaned up') || resultText.includes('from Redis')) {
                                 type = 'success';
                             } else if (resultText.includes('Skipped') || resultText.includes('pending tasks')) {
                                 type = 'warning';
                             } else if (resultText.includes('No dead consumers')) {
                                 type = 'info';
                             }
                             
                             window.dispatchEvent(new CustomEvent('toast', { 
                                 detail: { message: resultText, type } 
                             }));
                             
                             showCleanupModal = false;
                             
                             // Refresh consumer list after cleanup
                             setTimeout(() => {
                                 htmx.trigger('#consumers-content', 'manualRefresh');
                             }, 100);
                         }
                     ">
                    <button 
                        @click="showCleanupModal = true"
                        class="text-xs px-3 py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600/50 hover:border-gray-500 rounded-lg font-medium transition-all flex items-center gap-2"
                        title="Remove dead consumer entries"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span id="cleanup-indicator" class="htmx-indicator absolute">
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span>Cleanup Dead</span>
                    </button>
                    <div class="relative inline-flex items-center group">
                        <svg class="w-5 h-5 text-gray-400 hover:text-gray-200 cursor-help transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="absolute top-full mt-2 right-0 w-80 bg-gray-800 border border-gray-700 rounded-lg p-3 text-xs text-gray-300 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                            <div class="font-semibold text-white mb-1.5">Consumer Cleanup</div>
                            <div class="space-y-1.5">
                                <p>Removes dead consumer entries from Redis (maintenance task).</p>
                                <p class="text-gray-400"><span class="text-amber-400 font-medium">Criteria:</span> 0 pending tasks + idle > 10 minutes</p>
                                <p class="text-gray-500 text-[11px] italic">Safe operation - only removes inactive consumers with no work.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Cleanup Confirmation Modal -->
                    <div x-show="showCleanupModal" 
                         x-cloak
                         @click.self="showCleanupModal = false"
                         class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm"
                         style="display: none;">
                        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden"
                             @click.stop=""
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 scale-95"
                             x-transition:enter-end="opacity-100 scale-100">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-gray-800/50 to-gray-700/30 px-6 py-4 border-b border-gray-700">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-amber-600/20 flex items-center justify-center border border-amber-600/30">
                                        <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">Consumer Cleanup</h3>
                                        <p class="text-sm text-gray-400">Remove dead consumer entries from Redis</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Body -->
                            <div class="px-6 py-5 space-y-4">
                                <p class="text-gray-300">This will safely remove inactive consumer entries from Redis:</p>
                                
                                <div class="bg-gray-800/50 rounded-lg p-4 space-y-2 border border-gray-700">
                                    <div class="flex items-start gap-2 text-sm">
                                        <span class="text-amber-400 mt-0.5">üóëÔ∏è</span>
                                        <div>
                                            <span class="text-gray-400">Target:</span>
                                            <span class="text-white font-medium ml-1">Dead consumers (idle > 10 min, 0 pending)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-2 text-sm">
                                        <span class="text-emerald-400 mt-0.5">‚úì</span>
                                        <div>
                                            <span class="text-gray-400">Pending Tasks:</span>
                                            <span class="text-white font-medium ml-1">0 (no tasks will be lost)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-2 text-sm">
                                        <span class="text-blue-400 mt-0.5">üì¶</span>
                                        <div>
                                            <span class="text-gray-400">Consumer Group:</span>
                                            <span class="text-white font-medium ml-1">{{.SelectedGroup}}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-emerald-900/20 border border-emerald-700/30 rounded-lg p-3">
                                    <p class="text-sm text-emerald-300 flex items-center gap-2">
                                        <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span><strong>Active</strong> and <strong>idle</strong> workers will NOT be affected.</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="px-6 py-4 bg-gray-800/30 border-t border-gray-700">
                                <div id="cleanup-result" class="hidden"></div>
                                <div class="flex items-center justify-end gap-3">
                                    <button 
                                        @click="showCleanupModal = false"
                                        class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium transition-colors">
                                        Cancel
                                    </button>
                                    <button 
                                        hx-post="/admin/cleanup-consumers?group={{.SelectedGroup}}"
                                        hx-swap="innerHTML"
                                        hx-target="#cleanup-result"
                                        hx-indicator="#cleanup-indicator"
                                        class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm font-medium transition-all hover:shadow-lg hover:shadow-amber-500/20 flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Cleanup Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
        <div class="p-3 space-y-2" x-show="expanded" x-transition>
            <div id="consumers-content" 
                 class="space-y-2" 
                 hx-get="/partials/consumers?group={{.SelectedGroup}}" 
                 hx-trigger="load, every 30s, manualRefresh" 
                 hx-swap="innerHTML"
                 hx-indicator="#refresh-indicator">
            {{if .Consumers}}
                {{range .Consumers}}
                <div class="flex items-center justify-between p-3 bg-gray-900/50 rounded-lg hover:bg-gray-900/70 transition-colors border border-gray-700/30">
                    <div class="flex items-center gap-3 flex-1">
                        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs {{.StatusClass}} font-medium">
                            {{.Status}}
                        </span>
                        <span class="text-sm font-mono text-strego-400">{{.Name}}</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm flex-shrink-0">
                        <div class="flex items-center gap-1.5 w-[180px]">
                            <span class="text-gray-400">Pending in PEL:</span>
                            <span class="text-yellow-400 font-medium tabular-nums min-w-[4ch] inline-block text-right">{{.Pending}}</span>
                            <div class="relative inline-flex items-center group">
                                <svg class="w-3.5 h-3.5 text-gray-600 hover:text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                                    <div class="bg-gray-800 text-white text-xs rounded py-1.5 px-2 w-48 shadow-xl border border-gray-700 whitespace-nowrap">
                                        PEL = Pending Entries List (UNACKED tasks in Redis)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5 w-[120px] justify-end">
                            <span class="text-gray-400">Idle Time:</span>
                            <span class="text-gray-300 font-medium tabular-nums">{{.IdleTime}}</span>
                        </div>
                    </div>
                </div>
                {{end}}
            {{end}}
            </div>
    </div>
    </div>
    {{end}}

    <!-- Queues Overview (Redis) -->
    <div class="bg-gray-800/50 rounded-lg border border-gray-700/50" x-data="{ expanded: true }">
        <div class="p-3.5 border-b border-gray-700/50 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h4 class="font-semibold text-base">üì¨ Queues</h4>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-72 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Queue States (Redis Streams):</div>
                            <div class="space-y-1">
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-400 whitespace-nowrap">‚è≥ Pending:</span>
                                    <span class="text-gray-300">Messages in stream, not yet consumed (XLEN - PEL)</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-cyan-400 whitespace-nowrap">‚ö° Active:</span>
                                    <span class="text-gray-300">In PEL (delivered but not ACK'd) - includes crashed workers</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-red-400 whitespace-nowrap">üíÄ Dead:</span>
                                    <span class="text-gray-300">DLQ tasks (moved after all retries exhausted)</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-green-400 whitespace-nowrap">‚úÖ Completed:</span>
                                    <span class="text-gray-300">Acknowledged & removed from stream (from PostgreSQL)</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Real-time view for this consumer group only.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
            <a href="/queues" class="text-sm text-red-400 hover:text-red-300 transition-colors">View all ‚Üí</a>
                <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
        <div id="queues" x-show="expanded" x-transition>
            <div id="queues-content" 
                 hx-get="/partials/queues?group={{.SelectedGroup}}" 
                 hx-trigger="load, every 30s, manualRefresh" 
                 hx-swap="innerHTML"
                 hx-indicator="#refresh-indicator">
            {{if .Queues}}
                {{template "partial_queues.html" .Queues}}
            {{else}}
                <div class="p-8 text-center">
                    <div class="text-gray-600 mb-2">üì≠</div>
                    <p class="text-gray-500 text-sm">No queues found for this consumer group</p>
                    <p class="text-gray-600 text-xs mt-1">Try selecting a different group from the dropdown above</p>
                </div>
            {{end}}
            </div>
        </div>
    </div>

        </div>
    </div>
    <!-- End Redis Streams Section -->
</div>

<script>
document.body.addEventListener('htmx:afterSwap', function(event) {
    // Update timestamp via global function
    if (typeof window.updateDashboardTime === 'function') {
        window.updateDashboardTime();
    }
});
</script>
{{end}}

{{define "partial_stats.html"}}
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Pending</div>
        <div class="text-2xl font-bold text-yellow-400">{{.PendingTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Scheduled</div>
        <div class="text-2xl font-bold text-purple-400">{{.ScheduledTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Active</div>
        <div class="text-2xl font-bold text-cyan-400">{{.ActiveTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Retry</div>
        <div class="text-2xl font-bold text-orange-400">{{.RetryTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Completed</div>
        <div class="text-2xl font-bold text-green-400">{{.CompletedTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Dead</div>
        <div class="text-2xl font-bold text-red-400">{{.DeadTasks}}</div>
    </div>
</div>
{{end}}

{{define "partial_queues.html"}}
<div class="divide-y divide-gray-700/30">
    {{range .}}
    <div class="p-4 flex items-center justify-between hover:bg-gray-900/30 transition-colors">
        <div class="flex items-center gap-3">
            <span class="text-lg">üì¨</span>
            <div>
                <a href="/queues/{{.Name}}" class="font-medium hover:text-red-400 transition-colors">{{.Name}}</a>
            </div>
        </div>
        <div class="flex items-center gap-5 text-sm flex-wrap">
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Pending}}</span> pending</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-purple-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Scheduled}}</span> scheduled</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-cyan-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Active}}</span> active</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-orange-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Retry}}</span> retry</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Processed}}</span> completed</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0"></span>
                <span class="text-gray-400"><span class="tabular-nums min-w-[3ch] inline-block text-right">{{.Dead}}</span> dead</span>
            </div>
        </div>
    </div>
    {{else}}
    <div class="p-4 text-gray-500 text-sm">No queues found</div>
    {{end}}
</div>
{{end}}

{{define "dashboard.html"}}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
        <h2 class="text-2xl font-bold">Dashboard</h2>
            <p class="text-xs text-gray-500 mt-1.5 flex items-center gap-3">
                <span class="inline-flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-red-400 font-medium">Real-time</span>
                    <span class="text-gray-600">Redis Streams</span>
                </span>
                <span class="text-gray-700">‚Ä¢</span>
                <span class="inline-flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span>
                    <span class="text-purple-400 font-medium">Historical</span>
                    <span class="text-gray-600">PostgreSQL</span>
                </span>
            </p>
        </div>
        <div class="flex items-center gap-4">
            <!-- Consumer Group Selector -->
            {{if .ConsumerGroups}}
            <div class="flex items-center gap-3">
                <label class="text-sm text-gray-400">Consumer Group:</label>
                <select 
                    onchange="window.location.href = '/?group=' + this.value"
                    class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-strego-500"
                >
                    {{range .ConsumerGroups}}
                    <option value="{{.Name}}" {{if eq $.SelectedGroup .Name}}selected{{end}}>
                        {{.Name}} ({{.ConsumerCount}} workers)
                    </option>
                    {{end}}
                </select>
            </div>
            {{else}}
            <div class="text-sm text-gray-500 px-4 py-2 bg-gray-800/50 rounded-lg">
                No active consumer groups
            </div>
            {{end}}
        <div class="flex items-center gap-2 text-sm text-gray-500">
            <span class="htmx-indicator">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
            <span>Auto-refresh: 5s</span>
            </div>
        </div>
    </div>

    <!-- Stats Cards (PostgreSQL) -->
        {{if .Stats}}
    <div class="bg-gray-900 rounded-xl border border-gray-800" x-data="{ expanded: true }">
        <div class="p-4 border-b border-gray-800 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h3 class="font-semibold">üìä System Statistics</h3>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-purple-900/30 text-purple-400 border border-purple-800/50">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                        <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                        <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                    </svg>
                    Historical ‚Ä¢ PostgreSQL
                </span>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-64 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Task States (PostgreSQL):</div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-400">‚è≥ Pending:</span>
                                    <span class="text-gray-300">Not yet picked up by any worker</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-cyan-400">‚ö° Active:</span>
                                    <span class="text-gray-300">Currently being processed</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-green-400">‚úÖ Completed:</span>
                                    <span class="text-gray-300">Successfully finished</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-red-400">üíÄ Dead:</span>
                                    <span class="text-gray-300">Failed after max retries</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Historical data aggregated across all consumer groups.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="p-4" x-show="expanded" x-transition>
            <div id="stats" hx-get="/partials/stats" hx-trigger="load, every 5s" hx-swap="innerHTML">
                {{template "partial_stats.html" .Stats}}
            </div>
        </div>
    </div>
    {{end}}

    <!-- Workers in Consumer Group (Redis) -->
    {{if .Consumers}}
    <div class="bg-gray-900 rounded-xl border border-gray-800" x-data="{ expanded: true }">
        <div class="p-4 border-b border-gray-800 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h3 class="font-semibold">üë• Workers in Consumer Group</h3>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-red-900/30 text-red-400 border border-red-800/50">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    Real-time ‚Ä¢ Redis Streams
                </span>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-64 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Worker Status:</div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-green-400">üü¢ Active:</span>
                                    <span class="text-gray-300">Idle &lt; 1 minute</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-yellow-400">üü° Idle:</span>
                                    <span class="text-gray-300">Idle 1-5 minutes</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-red-400">üî¥ Dead:</span>
                                    <span class="text-gray-300">Idle &gt; 5 minutes</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Dead workers with pending tasks will auto-recover via XAUTOCLAIM.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-500">{{len .Consumers}} workers</span>
                <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
        <div class="p-4 space-y-2" x-show="expanded" x-transition>
            {{range .Consumers}}
            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg hover:bg-gray-800/70 transition-colors">
                <div class="flex items-center gap-3 flex-1">
                    <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs {{.StatusClass}} font-medium">
                        {{.Status}}
                    </span>
                    <span class="text-sm font-mono text-strego-400">{{.Name}}</span>
                </div>
                <div class="flex items-center gap-4 text-xs">
                    <div class="flex items-center gap-1.5">
                        <span class="text-gray-400">Pending in PEL: <span class="text-yellow-400 font-medium">{{.Pending}}</span></span>
                        <div class="relative inline-flex items-center group">
                            <svg class="w-3.5 h-3.5 text-gray-600 hover:text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                                <div class="bg-gray-800 text-white text-xs rounded py-1.5 px-2 w-48 shadow-xl border border-gray-700 whitespace-nowrap">
                                    PEL = Pending Entries List (UNACKED tasks in Redis)
                                </div>
                            </div>
                        </div>
                    </div>
                    <span class="text-gray-400">Idle Time: <span class="text-gray-300 font-medium">{{.IdleTime}}</span></span>
                </div>
            </div>
        {{end}}
    </div>
    </div>
    {{end}}

    <!-- Queues Overview (Redis) -->
    <div class="bg-gray-900 rounded-xl border border-gray-800" x-data="{ expanded: true }">
        <div class="p-4 border-b border-gray-800 flex items-center justify-between cursor-pointer" @click="expanded = !expanded">
            <div class="flex items-center gap-3">
                <h3 class="font-semibold">üì¨ Queues {{if .SelectedGroup}}<span class="text-gray-500 text-sm font-normal">for {{.SelectedGroup}}</span>{{end}}</h3>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-red-900/30 text-red-400 border border-red-800/50">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    Real-time ‚Ä¢ Redis Streams
                </span>
                <div class="relative inline-flex items-center group" @click.stop="">
                    <svg class="w-4 h-4 text-gray-500 hover:text-gray-300 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 hidden group-hover:block z-50">
                        <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 w-72 shadow-xl border border-gray-700">
                            <div class="font-semibold mb-2">Queue States (Redis Streams):</div>
                            <div class="space-y-1">
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-400 whitespace-nowrap">‚è≥ Pending:</span>
                                    <span class="text-gray-300">Messages in stream, not yet consumed (XLEN - PEL)</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-cyan-400 whitespace-nowrap">‚ö° Active:</span>
                                    <span class="text-gray-300">In PEL (delivered but not ACK'd) - includes crashed workers</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-red-400 whitespace-nowrap">üíÄ Dead:</span>
                                    <span class="text-gray-300">DLQ tasks (moved after all retries exhausted)</span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-green-400 whitespace-nowrap">‚úÖ Completed:</span>
                                    <span class="text-gray-300">Acknowledged & removed from stream (from PostgreSQL)</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 text-gray-400 text-xs">
                                Real-time view for this consumer group only.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
            <a href="/queues" class="text-sm text-strego-400 hover:text-strego-300">View all ‚Üí</a>
                <svg class="w-5 h-5 text-gray-400 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
        <div id="queues" x-show="expanded" x-transition>
            {{if .Queues}}
                {{template "partial_queues.html" .Queues}}
            {{else}}
                <div class="p-8 text-center">
                    <div class="text-gray-600 mb-2">üì≠</div>
                    <p class="text-gray-500 text-sm">No queues found for this consumer group</p>
                    <p class="text-gray-600 text-xs mt-1">Try selecting a different group from the dropdown above</p>
                </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{define "partial_stats.html"}}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Pending</div>
        <div class="text-2xl font-bold text-yellow-400">{{.PendingTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Active</div>
        <div class="text-2xl font-bold text-cyan-400">{{.ActiveTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Completed</div>
        <div class="text-2xl font-bold text-green-400">{{.CompletedTasks}}</div>
    </div>
    <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
        <div class="text-sm text-gray-500 mb-1">Dead</div>
        <div class="text-2xl font-bold text-red-400">{{.DeadTasks}}</div>
    </div>
</div>
{{end}}

{{define "partial_queues.html"}}
<div class="divide-y divide-gray-800">
    {{range .}}
    <div class="p-4 flex items-center justify-between hover:bg-gray-800/50 transition-colors">
        <div class="flex items-center gap-3">
            <span class="text-lg">üì¨</span>
            <div>
                <a href="/queues/{{.Name}}" class="font-medium hover:text-strego-400">{{.Name}}</a>
            </div>
        </div>
        <div class="flex items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                <span class="text-gray-400">{{.Pending}} pending</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
                <span class="text-gray-400">{{.Active}} active</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                <span class="text-gray-400">{{.Dead}} dead</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                <span class="text-gray-400">{{.Processed}} completed</span>
            </div>
        </div>
    </div>
    {{else}}
    <div class="p-4 text-gray-500 text-sm">No queues found</div>
    {{end}}
</div>
{{end}}
